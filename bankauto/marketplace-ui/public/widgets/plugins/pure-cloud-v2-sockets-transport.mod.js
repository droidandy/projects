/*!
 * widgets
 * @version: 9.0.017.00
 * @license: Genesys Telecom Labs
 */
widgetsJsonpFunction([20],{"./webapp/plugins/cx-webchat-service/transports/pure-cloud-v2-sockets-transport.js":function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){var n={};for(var o in e)t.indexOf(o)>=0||Object.prototype.hasOwnProperty.call(e,o)&&(n[o]=e[o]);return n}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},d=n("./node_modules/jquery/dist/jquery.js"),m=o(d),g=n("./webapp/plugins/cx-common/cx-common.js"),u=o(g),p={init:function(e){p.transport=e},updateSessionCookies:function(){var e=p.transport,t=e.oSessionData;u.default.setCookie(e.sCookie_Keys,t.jwt),u.default.setCookie(e.sCookie_ConversationID,t.conversationId),u.default.setCookie(e.sCookie_MemberID,t.memberId),u.default.setCookie(e.sCookie_WS_URL,t.WebSocketUrl),u.default.setCookie(e.sLastMessageId,t.lastMessageId)},removeCookies:function(){var e=p.transport;u.default.deleteCookie(e.sCookie_Keys),u.default.deleteCookie(e.sCookie_ConversationID),u.default.deleteCookie(e.sCookie_MemberID),u.default.deleteCookie(e.sCookie_WS_URL),u.default.deleteCookie(e.sLastMessageId)},getSessionFromCookie:function(){var e=p.transport,t=p.transport.oSessionData;t.jwt=u.default.getCookie(e.sCookie_Keys),t.conversationId=u.default.getCookie(e.sCookie_ConversationID),t.memberId=u.default.getCookie(e.sCookie_MemberID),t.WebSocketUrl=u.default.getCookie(e.sCookie_WS_URL),t.lastMessageId=u.default.getCookie(e.sLastMessageId),e.customerId=t.memberId},terminateChatSession:function(){var e=p.transport;p.removeCookies(),e.bSessionActive=!1,e.mySocket&&(clearTimeout(e.WebSocketTimeout),e.mySocket.readyState===WebSocket.OPEN&&setTimeout(function(){e.mySocket&&e.mySocket.close()},e.socketConnectionCloseTime),e.mySocket=null),e.oAgents={},e.oClients={},e.oWorkFlows={},e.oSessionData={},e.bAllMessagesReceived=!1,e.bOpeningSocket=!1,e.bFetchingMembers=!1},getFormData:function(e){if(e){var t=u.default.getBrowserandOS(),n=e.firstname,o=e.lastname,s=e.nickname,r=a(e,["firstname","lastname","nickname"]),d={_genesys_source:u.default.isMobileDevice()?"mobile":"web",_genesys_referrer:document.referrer,_genesys_url:document.location.href,_genesys_pageTitle:document.title,_genesys_browser:t.browser,_genesys_OS:t.os},m=c({},p.transport.oUserData,d);return"object"==i(e.userData)&&(m=c({},m,e.userData)),c({firstName:n,lastName:o,nickname:s||n||e.firstName},m,r)}return{}},parseTranscript:function(e,t){var n=p.transport,o=[];clearInterval(n.fWatchMembers),n.fWatchMembers=!1,m.default.each(e||[],function(){var e=this;p.checkChatIndexHash(e.id)&&o.push(p.parseFormatmessage(e,t))}),o.sort(function(e,t){return e.timestamp-t.timestamp}),t&&"fetchHistory"==t.type&&o.sort(function(e,t){return t.index-e.index}),o.length>0&&n.onMessageReceived({data:{originalMessages:e,messages:o,restoring:n.bRestoring,oldMessages:t&&"fetchHistory"==t.type}})},checkChatIndexHash:function(e){var t=p.transport;return!t.oChatIndexHash[e]&&(t.oChatIndexHash[e]=!0,!0)},sendBotConnected:function(e,t){var n=p.transport;p.postMessageWithTimestamp({type:"ParticipantJoined",index:t?t.index:0,timestamp:t?t.timestamp:Date.now(),from:{type:"Bot"}}),n.onBotConnected({message:e,agents:n.oAgents})},sendBotDisconnected:function(e,t){var n=p.transport;p.postMessageWithTimestamp({type:"ParticipantLeft",index:t?t.index:"",timestamp:t?t.timestamp:Date.now(),from:{type:"Bot"}}),n.onBotDisconnected({message:e,agents:n.oAgents})},parseMessageForEvents:function(e,t){var n=p.transport,o=t||{},s=o.type,a=!(!s||"restore"!==s&&"fetchHistory"!==s),r={};if(e&&e.state){var i=e.state,c=e.role,d=e.sender.id;if("CONNECTED"==i)switch("AGENT"==c&&n.oAgents[d]&&(n.oAgents[d].connected=!0,n.oAgents[d].supervisor=!1,n.oAgents[d].connectedTime=e.joinDate,n.oCacheAgents[d]=JSON.parse(JSON.stringify(n.oAgents[d]))),r={message:e,agents:n.oAgents},c){case"AGENT":p.checkEventChanged(d,i)&&n.onAgentConnected(r);break;case"CUSTOMER":p.checkEventChanged(d,i)&&n.onClientConnected(r);break;case"WORKFLOW":n.botEventsEnabled&&p.checkEventChanged(d,i)&&n.onBotConnected(r)}else if("DISCONNECTED"==i)switch("AGENT"==c&&n.oAgents[d]&&(n.oAgents[d].connected=!1,n.oAgents[d].disconnectedTime=e.leaveDate),r={message:e,agents:n.oAgents},c){case"AGENT":n.onAgentDisconnected(r),n.onAgentTypingStopped(r);break;case"CUSTOMER":n.onClientDisconnected(r);break;case"WORKFLOW":n.botEventsEnabled&&n.onBotDisconnected(r)}a&&(n.oMembers[d]=e,n.oMembers[d].lastEvent=i)}},parseFormatmessage:function(e,t){var n=p.transport,o=new Date(e.timestamp||e.joinDate||e.leaveDate).getTime(),s=t||{},a=s.type,r=!(!a||"restore"!==a&&"fetchHistory"!==a),i={},c={};if(i.type=n.webSocketStateMapping[e.bodyType]||"Message","Message"===i.type&&(i.text=e.body),i.restoring=n.bRestoring,i.index=o,i.timestamp=o,n.oPresences&&Object.keys(n.oPresences).length){c=n.oPresences.filter(function(t){return t.id==e.sender.id});for(var d=0;d<c.length;d++)c=c[d],e.role=c&&c.role?c.role:n.oMembers[e.sender.id].role,e.state=n.stateMapping[i.type],"AGENT"==e.role&&(n.agentMsgFormat.avatar=c&&c.avatarImageUrl?c.avatarImageUrl:"",c&&"CONNECTED"==c.state&&(n.agentMsgFormat.from.name=c&&c.displayName?c.displayName:""))}if(e.role&&"AGENT"===e.role&&n.agentMsgFormat.avatar&&(i.avatar=n.agentMsgFormat.avatar),r&&c.state&&e.role){var m=c.role;p.checkEventChanged(c.id,e.state)&&("AGENT"==m&&(i.from={type:"Agent",name:c.displayName},n.oAgents[c.id]={name:c.displayName}),"CUSTOMER"==m&&(i.from={type:"Client",name:c.displayName},n.oClients[c.id]={name:c.displayName}),"WORKFLOW"===m&&(n.botEventsEnabled&&"DISCONNECTED"===e.state&&(i.from={type:"Bot"}),"standard"===e.bodyType||n.botEventsEnabled&&"member-join"===e.bodyType?(i.from={type:"Bot"},n.oWorkFlows[c.id]={type:"Bot"}):"notice"===e.bodyType&&(n.oWorkFlows[c.id]={type:"External"})))}if("Message"===i.type){var g=p.getSenderById(e);g&&(r||(i.from=g.from||{}),g.avatar&&(i.avatar=g.avatar))}return p.parseMessageForEvents(e,t),i},getSenderById:function(e){var t=p.transport,n=e.sender.id,o=t.oMembers[n]||t.oWorkFlows[n],s="",a={id:n};return o&&("WORKFLOW"===o.role?"standard"===e.bodyType?a.type="Bot":"notice"===e.bodyType&&(a.type="External"):"AGENT"===o.role?(a.name=t.oAgents[n]&&t.oAgents[n].name||t.oMembers[n]&&t.oMembers[n].displayName||"Agent",a.type="Agent",s=t.oMembers[n]&&t.oMembers[n].avatarImageUrl):"CUSTOMER"===o.role&&(a.name=t.oClients[n]&&t.oClients[n].name||t.oMembers[n]&&t.oMembers[n].displayName||"Client",a.type="Client")),{from:a,avatar:s}},checkEventChanged:function(e,t){var n=p.transport,o=n.oMembers;if(Object.keys(o).length&&o[e]){var s=o[e];return!s.lastEvent||s.lastEvent!==t}return!0},processSocketFrame:function(e){var t=p.transport,n=t.oSessionData,o=e&&e.eventBody,s=e&&e.metadata;if(o&&("WebSocket Heartbeat"==o.message||s)&&(clearTimeout(t.WebSocketTimeout),t.WebSocketTimeout=setTimeout(function(){t.mySocket&&WebSocket.OPEN&&(t.bSocketConnectionLost=!0,t.onDisconnected(),t.mySocket.close())},t.socketHeartbeatTrackerInterval)),s&&o){var a=s.type,r="";switch(a){case"typing-indicator":var i=o.sender.id,c=t.oAgents,d={},m=[],g="";if(t.oPresences&&Object.keys(t.oPresences).length){m=t.oPresences.filter(function(e){return e.id==i});for(var u=0;u<m.length;u++)m=m[u],"AGENT"==t.oMembers[i].role&&(t.agentMsgFormat.avatar=m&&m.avatarImageUrl?m.avatarImageUrl:"")}g=t.agentMsgFormat.avatar,c[i]&&(d.from={name:c[i].name,id:i,avatar:g},t.onAgentTypingStarted(d),t.bAgentTypingTimerActive||(t.bAgentTypingTimerActive=!0,setTimeout(function(){t.bAgentTypingTimerActive=!1,t.onAgentTypingTimeout()},t.iAgentTypingTimer)));break;case"member-change":var l=o.member,f="";r=l.id,f=t.oMembers[r]&&t.oMembers[r].lastEvent?t.oMembers[r].lastEvent:"",n.memberId&&t.bSessionActive?r!=n.memberId?p.getMemberById(r).done(function(e){t.oMembers[r]=e,f&&(t.oMembers[r].lastEvent=f),e&&p.checkEventChanged(r,l.state)&&("AGENT"==e.role?(t.agentMsgFormat.avatar=e.avatarImageUrl,"DISCONNECTED"==e.state&&(t.agentMsgFormat.type="ParticipantLeft",t.agentMsgFormat.from.name=e.displayName||"",void 0!==t.oAgents[r]&&(t.oAgents[r].name=e.displayName,t.oAgents[r].connected=!1,t.oAgents[r].disconnectedTime=Date.now()),t.oCacheAgents[r]&&t.oCacheAgents[r].connected&&(t.oCacheAgents[r].connected=!1,t.oCacheAgents[r].disconnectedTime=Date.now(),t.oCacheAgents[r].name=e.displayName,p.postMessageWithTimestamp(t.agentMsgFormat),t.onAgentDisconnected({message:e,agents:t.oCacheAgents}))),"CONNECTED"==e.state&&(t.agentMsgFormat.type="ParticipantJoined",t.agentMsgFormat.from.name=e.displayName||"",void 0==t.oAgents[r]&&(t.oAgents[r]={name:e.displayName||"",connected:!0,supervisor:!1,connectedTime:Date.now(),disconnectedTime:!1}),t.oCacheAgents[r]=JSON.parse(JSON.stringify(t.oAgents[r])),t.oCacheAgents[r].connected=!0,p.postMessageWithTimestamp(t.agentMsgFormat),t.onAgentConnected({message:e,agents:t.oAgents}))):"WORKFLOW"===e.role&&("CONNECTED"==e.state&&(void 0==t.oWorkFlows[r]&&(t.oWorkFlows[r]={name:e.displayName||"",role:"WORKFLOW",connected:!0,connectedTime:Date.now(),disconnectedTime:!1}),t.botEventsEnabled&&p.sendBotConnected(e)),"DISCONNECTED"==e.state&&(void 0!==t.oWorkFlows[r]&&(t.oWorkFlows[r].name=e.displayName||"",t.oWorkFlows[r].connected=!1,t.oWorkFlows[r].disconnectedTime=Date.now()),t.botEventsEnabled&&p.sendBotDisconnected(e))),t.oMembers[r]=e,t.oMembers[r].lastEvent=e.state),t.bFetchingMembers=!1}).fail(function(e){p.handleError(e)}):r==n.memberId&&("DISCONNECTED"===l.state&&t.bSessionActive&&(t.onChatEnded(),p.terminateChatSession()),t.oMembers[r]=l,t.oMembers[r].role="CUSTOMER",t.oMembers[r].lastEvent=l.state):!t.bSessionActive&&l&&"DISCONNECTED"==l.state&&t.customerId&&r!==t.customerId&&t.oCacheAgents[r]&&t.oCacheAgents[r].connected&&(t.agentMsgFormat.type="ParticipantLeft",p.postMessageWithTimestamp(t.agentMsgFormat),t.oCacheAgents[r].connected=!1,t.oCacheAgents[r].disconnectedTime=Date.now(),t.onAgentDisconnected({message:o,agents:t.oCacheAgents}));break;case"message":n.lastMessageId=o.id,p.updateSessionCookies(),t.aMsgsBuffer.push(o),t.fWatchMembers||(t.fWatchMembers=setInterval(function(){var e=t.aMsgsBuffer.filter(function(e){return e.sender.id?t.oMembers[e.sender.id]?e:void 0:e});t.bFetchingMembers||e.length!=t.aMsgsBuffer.length||(clearInterval(t.fWatchMembers),t.fWatchMembers=!1,p.parseTranscript(t.aMsgsBuffer),t.aMsgsBuffer=[])},t.iWatchMembers))}}},postMessageWithTimestamp:function(e){var t=p.transport;e.timestamp=Date.now(),e.index=e.timestamp,t.onMessageReceived({data:{originalMessages:[e],messages:[e],restoring:t.bRestoring}})},getNickname:function(e){return e.nickname?e.nickname:e.firstName&&e.lastName&&"string"==typeof e.firstName&&"string"==typeof e.lastName?e.firstName+" "+e.lastName:e.firstName&&"string"==typeof e.firstName?e.firstName:"Customer"},getPresences:function(){var e=m.default.Deferred(),t=p.transport,n=t.oSessionData,o=p.CreateUrl("/api/v2/webchat/guest/conversations/"+n.conversationId+"/members");return u.default.request(c({},t.oCommonRequestOption,{headers:{Authorization:"Bearer "+t.oSessionData.jwt},type:"GET",url:o,success:function(t){t&&e.resolve(t)},error:function(t){return e.reject(t)}})),e.promise()},requestMessages:function(e,t,n){var o=p.transport;u.default.request(c({},o.oCommonRequestOption,{headers:{Authorization:"Bearer "+o.oSessionData.jwt},type:"GET",url:e,success:function(s){s?(s.entities&&(t=t.concat(s.entities)),s.next?(e=o.dataURL+s.next,p.requestMessages(e,t,n)):n.resolve(t)):n.reject(s)},error:function(e){return n.reject(e)}}))},getAllMessages:function(){var e=m.default.Deferred(),t=p.transport,n=t.oSessionData,o=[],s=p.CreateUrl("/api/v2/webchat/guest/conversations/"+n.conversationId+"/messages");return p.requestMessages(s,o,e),e.promise()},getOfflineMessages:function(){var e=m.default.Deferred(),t=m.default.Deferred(),n=p.transport,o=n.oSessionData,s="",a=[];if(o.conversationId&&o.lastMessageId)return s=p.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/messages",{after:o.lastMessageId}),p.requestMessages(s,a,e),e.promise().done(function(e){p.getPresences().done(function(o){n.bFetchingMembers=!1,n.oPresences=o.entities,p.parseTranscript(e),t.resolve()}).fail(function(){t.resolve()})}),t.promise()},getNextHundredMessages:function(e){var t=m.default.Deferred(),n=p.transport,o=n.oSessionData,s=[],a="",r={sortOrder:"descending",maxResults:n.maxMessagePageSize};return""!==o.nextMsgURL&&o.previousLastMsgId&&(r.before=o.previousLastMsgId),!n.bAllMessagesReceived&&o.conversationId?(a=p.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/messages",r),u.default.request(c({},n.oCommonRequestOption,{headers:{Authorization:"Bearer "+n.oSessionData.jwt},type:"GET",url:a,success:function(a){a?(a.entities&&(s=a.entities),a.next?(o.previousLastMsgId=s[s.length-1].id,o.nextMsgURL=a.next,n.bAllMessagesReceived=!1):(n.bAllMessagesReceived=!0,o.nextMsgURL=""),p.getPresences().done(function(o){n.oPresences=o.entities,s.length&&s.length<a.pageSize&&!a.next&&(n.bAllMessagesReceived=!0),p.parseTranscript(s,e),t.resolve()}).fail(function(e){t.reject(e)})):(p.handleError(a),t.reject("200 but no response from server"))},error:function(e){n.onError(e),t.reject()}}))):t.reject("No more messages to fetch"),t.promise()},sendRequest:function(e,t){var n=m.default.Deferred(),o=p.transport,s=e?{data:JSON.stringify(e)}:{};return u.default.request(c({},o.oCommonRequestOption,{headers:{Authorization:"Bearer "+o.oSessionData.jwt},type:"POST",url:t},s,{success:function(e){return n.resolve(e)},error:function(e){return n.reject(e)}})),n.promise()},getMemberById:function(e){var t=m.default.Deferred(),n=p.transport,o=n.oSessionData;return o.conversationId&&e?(n.bFetchingMembers=!0,u.default.request(c({},n.oCommonRequestOption,{headers:{Authorization:"Bearer "+n.oSessionData.jwt},type:"GET",url:p.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/members/"+e),success:function(e){e?t.resolve({id:e.id,displayName:e.displayName,role:e.role,customFields:e.customFields,state:e.state,avatarImageUrl:e.avatarImageUrl||""}):(t.reject(e),n.onError(e))},error:function(e){n.bFetchingMembers=!1,p.handleError(e),t.reject(e||{})}}))):t.reject("No session data available"),t.promise()},getMe:function(){var e=m.default.Deferred(),t=p.transport,n=t.oSessionData;return p.getMemberById(n.memberId).done(function(o){t.bFetchingMembers=!1,t.oClients[n.memberId]={name:o.displayName},t.oMembers[n.memberId]=o,e.resolve(o)}).fail(function(t){e.reject(t)}),e.promise()},getConversationState:function(){var e=m.default.Deferred();return p.getMe().done(function(t){e.resolve(t)}).fail(function(t){e.reject("failed to get the conversation state")}),e.promise()},handleError:function(e){var t=p.transport,n=e&&(e.responseJSON||e.responseText&&JSON.parse(e.responseText)||{});if(n)var o=n.status;t.onError({code:e.errorReason||o&&t.errorPrefix+o||"",response:e})},CreateUrl:function(e,t){var n="",o=p.transport;if(t){n="?";var s=[];for(var a in t){var r=t[a];"string"!=typeof r&&"number"!=typeof r||s.push(a+"="+t[a])}n+=s.join("&")}return""+o.dataURL+e+n},afterConnectionRestore:function(){var e=p.transport;e.bOpeningSocket=!1,p.getOfflineMessages().done(function(){p.getConversationState().done(function(t){e.bSessionActive&&t&&"DISCONNECTED"===t.state&&(e.onChatEnded(),p.terminateChatSession())})})},subscribeSocketEvents:function(e){var t=p.transport;t.mySocket.onmessage=function(e){var t=JSON.parse(e.data);p.processSocketFrame(t)},t.mySocket.addEventListener("close",function(e){clearTimeout(t.WebSocketTimeout),t.bSocketConnectionLost=!0,t.mySocket=null,t.bSessionActive&&(t.bOpeningSocket=!0,p.startWebSocketConnection(),p.afterConnectionRestore())}),t.mySocket.addEventListener("error",function(n){t.bSocketConnectionLost||p.handleError(n),t.bSessionActive||(e.reject("websocket failed to open"),t.bRestoring&&t.onRestoreFailed()),t.bOpeningSocket=!1})},startWebSocketConnection:function(e){var t=p.transport,n=m.default.Deferred();return e&&(t.oSessionData={jwt:e.jwt,conversationId:e.id,memberId:e.member.id,WebSocketUrl:e.eventStreamUri},t.customerId=e.member.id),t.mySocket=new WebSocket(t.oSessionData.WebSocketUrl),t.mySocket.addEventListener("open",function(e){t.bSessionActive=!0,t.bSocketConnectionLost&&(t.bSocketConnectionLost=!1,t.onReconnected()),n.resolve()}),p.subscribeSocketEvents(n),n.promise()}},l=function(){function e(t){if(s(this,e),this.transportType="",this.dataURL="",this.mySocket={},this.oUserData=t.oUserData,this.errorPrefix=t.transport.type+"-",this.oChatIndexHash={},this.oPresences={},this.oMembers={},this.oAgents={},this.oClients={},this.oCacheAgents={},this.oWorkFlows={},this.aMsgsBuffer=[],this.maxMessagePageSize=100,this.botEventsEnabled=!1,this.oInteractionData=t.oInteractionData,this.bOpeningSocket=!1,this.bSessionActive=!1,this.bRestoring=!1,this.bAllMessagesReceived=!1,this.bFetchingMembers=!1,this.ajaxTimeout=t.iAjaxTimeout&&t.iAjaxTimeout>=12e3?t.iAjaxTimeout:12e3,this.oCommonRequestOption={timeout:this.ajaxTimeout,crossDomain:!0,dataType:"json",contentType:"application/json"},this.conversationOptions={deploymentId:"",organizationId:"",routingTarget:{targetAddress:""},memberInfo:{displayName:"Customer",role:"CUSTOMER",customFields:{}}},this.oMapping={"form.firstname":{target:"memberInfo.customFields.firstName",type:"string"},"form.lastname":{target:"memberInfo.customFields.lastName",type:"string"},"form.email":{target:"memberInfo.customFields.email",type:"string"},"form.subject":{target:"memberInfo.customFields.subject",type:"string"},"userData.phone":{target:"memberInfo.customFields.phoneNumber",type:"string"},"interactionData.userData.phone":{target:"memberInfo.customFields.phoneNumber",type:"string"},"interactionData.routing.targetType":{target:"routingTarget.targetType",type:"string",default:"QUEUE"},"interactionData.routing.targetAddress":{target:"routingTarget.targetAddress",type:"string"},"interactionData.routing.skills":{target:"routingTarget.skills"},"interactionData.routing.priority":{target:"routingTarget.priority",type:"number"},"interactionData.routing.language":{target:"routingTarget.language",type:"string"},"interactionData.journey.customerId":{target:"journeyContext.customer.id",type:"string"},"interactionData.journey.customerIdType":{target:"journeyContext.customer.idType",type:"string"},"interactionData.journey.sessionId":{target:"journeyContext.customerSession.id",type:"string"},"interactionData.journey.sessionType":{target:"journeyContext.customerSession.type",type:"string"},"interactionData.journey.actionId":{target:"journeyContext.triggeringAction.id",type:"string"},"interactionData.journey.actionMapId":{target:"journeyContext.triggeringAction.actionMap.id",type:"string"},"interactionData.journey.actionMapVersion":{target:"journeyContext.triggeringAction.actionMap.version",type:"number"}},this.webSocketStateMapping={"member-join":"ParticipantJoined","member-leave":"ParticipantLeft",standard:"Message",notice:"Message"},this.stateMapping={ParticipantJoined:"CONNECTED",ParticipantLeft:"DISCONNECTED"},this.oSessionData={jwt:"",conversationId:"",memberId:"",displayName:"",WebSocketUrl:"",nextMsgURL:"",lastMessageId:""},this.customerId="",this.bSocketConnectionLost=!1,this.socketReconnectInterval=2e3,this.socketHeartbeatTrackerInterval=14e3,this.socketConnectionCloseTime=2,this.capabilities={pagination:!0,fileUpload:!1},"object"==i(t.transport)){var n=t.transport;"string"==typeof n.type&&(this.transportType=n.type),"string"==typeof n.dataURL&&(this.dataURL=n.dataURL),"string"==typeof n.deploymentKey&&(this.conversationOptions.deploymentId=n.deploymentKey),"string"!=typeof n.organizationId&&"string"!=typeof n.orgGuid||(this.conversationOptions.organizationId=n.organizationId||n.orgGuid),"number"==typeof n.socketReconnectInterval&&(this.socketReconnectInterval=n.socketReconnectInterval),"number"==typeof n.socketHeartbeatTrackerInterval&&(this.socketHeartbeatTrackerInterval=n.socketHeartbeatTrackerInterval),"boolean"==typeof n.pagination&&(this.capabilities.pagination=n.pagination),"number"==typeof n.maxMessagePageSize&&(this.maxMessagePageSize=n.maxMessagePageSize),"boolean"==typeof n.botEventsEnabled&&(this.botEventsEnabled=n.botEventsEnabled),"number"==typeof n.socketConnectionCloseTime&&(this.socketConnectionCloseTime=n.socketConnectionCloseTime),this.conversationOptions=u.default.mapProperties(this.oMapping,n,this.conversationOptions)}this.sCookie_Keys=t.sCookie_Prefix+"."+this.transportType+".JWtoken",this.sCookie_ConversationID=t.sCookie_Prefix+"."+this.transportType+".ConversationID",this.sCookie_MemberID=t.sCookie_Prefix+"."+this.transportType+".MemberID",this.sCookie_WS_URL=t.sCookie_Prefix+"."+this.transportType+".WS_URL",this.sLastMessageId=t.sCookie_Prefix+"."+this.transportType+".LastMsgId",this.onChatStarted=this.onChatStarted.bind(this),this.onMessageReceived=this.onMessageReceived.bind(this),this.onRestore=this.onRestore.bind(this),this.onError=this.onError.bind(this),this.agentMsgFormat={type:"",text:"",restoring:!1,index:0,timestamp:0,from:{type:"Agent"}},this.conversationStarted={type:"ParticipantJoined",text:"",restoring:!1,index:0,timestamp:0,from:{type:"Client"}},this.iAgentTypingTimer=3e3,this.bAgentTypingTimerActive=!1,this.fWatchMembers=!1,this.iWatchMembers=700,p.init(this)}return r(e,[{key:"onChatStarted",value:function(e,t){}},{key:"onTypingStarted",value:function(e){}},{key:"onCapabilitiesChanged",value:function(e){}},{key:"onAgentTypingStarted",value:function(e){}},{key:"onAgentTypingTimeout",value:function(e){}},{key:"onMessageReceived",value:function(e){}},{key:"onChatEnded",value:function(e){}},{key:"onError",value:function(e){}},{key:"onRestore",value:function(e){}},{key:"onRestoreFailed",value:function(e){}},{key:"startChat",value:function(e){var t=m.default.Deferred(),n=this,o="",s=JSON.parse(JSON.stringify(n.conversationOptions)),a=p.getFormData(e.form);return s.memberInfo.customFields=m.default.extend(s.memberInfo.customFields,a,e.userData||{},!0),s.memberInfo.displayName=p.getNickname(a),"string"==typeof e.deploymentKey&&(s.deploymentId=e.deploymentKey),"string"!=typeof e.organizationId&&"string"!=typeof e.orgGuid||(s.organizationId=e.organizationId||e.orgGuid),n.oInteractionData&&Object.keys(n.oInteractionData).length>0&&(o=n.oInteractionData),e&&e.interactionData&&Object.keys(e.interactionData).length>0&&(o=e.interactionData),o&&(s.memberInfo.customFields=m.default.extend(s.memberInfo.customFields,o.userData||{},!0),s=u.default.mapProperties(n.oMapping,{interactionData:o,userData:s.memberInfo.customFields},s)),n.bSessionActive||n.bOpeningSocket||(n.bOpeningSocket=!0,u.default.request(c({},n.oCommonRequestOption,{type:"POST",url:p.CreateUrl("/api/v2/webchat/guest/conversations"),data:JSON.stringify(s),success:function(e){e?p.startWebSocketConnection(e).done(function(){p.updateSessionCookies(),n.onChatStarted({data:n.oSessionData},e),p.getMe(),t.resolve(),p.postMessageWithTimestamp(n.conversationStarted),n.bOpeningSocket=!1}):(t.reject("no response data in the api post request"),n.onError(e))},error:function(e){e.errorReason="StartFailed",n.bOpeningSocket=!1,t.reject(e||{}),p.handleError(e)}}))),t.promise()}},{key:"sendMessage",value:function(e){var t=m.default.Deferred(),n=this,o=n.oSessionData;if(n.bSessionActive){"text"==e.type&&(e.type="Text");var s=p.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/members/"+o.memberId+"/messages");p.sendRequest({body:e.message},s).done(function(e){o.lastMessageId=e.id,p.updateSessionCookies(),t.resolve()}).fail(function(e){e.errorReason="MessageFailed",p.handleError(e),t.reject()})}else t.reject("There is no active chat session.");return t.promise()}},{key:"sendFile",value:function(){return m.default.Deferred().reject("This transport doesn't support file uploads.").promise()}},{key:"sendTyping",value:function(e){var t=m.default.Deferred(),n=this,o=n.oSessionData;if(n.bSessionActive)if(e&&"TypingStopped"!==e.type){var s=p.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/members/"+o.memberId+"/typing");p.sendRequest("",s).done(function(e){e?t.resolve():t.reject("send typing indicator request returned no data")}).fail(function(e){t.reject(e||{})})}else t.resolve();else t.reject("trying to send typing indicator when session is not active");return t.promise()}},{key:"fetchHistory",value:function(){var e=m.default.Deferred();return this.capabilities.pagination?p.getNextHundredMessages({type:"fetchHistory"}).done(function(){e.resolve()}).fail(function(t){e.reject(t)}):e.reject("Fetching chat history on scroll is not enabled."),e.promise()}},{key:"fetchSessionData",value:function(){return this.oSessionData}},{key:"getAgents",value:function(){return this.oAgents}},{key:"asyncRestore",value:function(){var e=this,t=e.oSessionData,n=m.default.Deferred();return e.onCapabilitiesChanged(this.capabilities),e.bRestoring?(n.reject("Already restoring. Ignoring request."),!1):e.bSessionActive?void n.reject("Chat session is already active, ignoring restore command."):(p.getSessionFromCookie(),t.conversationId&&(e.bRestoring=!0,p.getConversationState().done(function(o){e.bFetchingMembers=!1,"CONNECTED"==o.state?(e.mySocket=new WebSocket(t.WebSocketUrl),p.subscribeSocketEvents(n),e.mySocket.addEventListener("open",function(t){e.bSessionActive=!0,e.bSocketConnectionLost=!1,e.mySocket.onmessage=function(e){var t=JSON.parse(e.data);p.processSocketFrame(t)},e.onRestore(),e.capabilities.pagination?p.getNextHundredMessages({type:"restore"}).done(function(){e.bRestoring=!1,n.resolve()}):p.getAllMessages().done(function(t){p.getPresences().done(function(n){e.oPresences=n.entities,p.parseTranscript(t,{type:"restore"})}),e.bRestoring=!1,n.resolve()}).fail(function(t){e.onRestoreFailed(t)})})):(e.onRestoreFailed(),n.reject("customer disconnected, conversation ended"))}).fail(function(t){e.onRestoreFailed(t),n.reject("failed to retrieve conversation state")})),n.promise())}},{key:"endChat",value:function(){var e=m.default.Deferred(),t=this.oSessionData,n=t.conversationId,o=t.memberId,s=this;return this.bSessionActive?(u.default.request({timeout:12e3,crossDomain:!0,contentType:"application/json; charset=utf-8",cache:!1,headers:{Authorization:"Bearer "+s.oSessionData.jwt},type:"DELETE",url:p.CreateUrl("/api/v2/webchat/guest/conversations/"+n+"/members/"+o),success:function(e){setTimeout(function(){s.bSessionActive||p.terminateChatSession()},500)}}).always(function(t,n,o){var a=o||t;if(a){var r=a.status,i=a.responseText;!r||204!=r&&200!=r?(s.onError({code:r||"",message:i&&i.message?i.message:""}),e.reject(a)):(s.bSessionActive&&s.onChatEnded(a),e.resolve(a))}else s.onError(),e.reject(a);p.terminateChatSession()}),e.promise()):(e.reject("There is no active chat session"),s.onChatEnded(),p.terminateChatSession(),e.promise())}},{key:"updateUserData",value:function(){return m.default.Deferred().reject("This transport doesn't support updating userData during an active chat session.").promise()}},{key:"updateInteractionData",value:function(){return m.default.Deferred().reject("This transport doesn't support updating interactionData during an active chat session.").promise()}}]),e}();CXBus.registerModule("pure-cloud-v2-sockets-transport",l)}},["./webapp/plugins/cx-webchat-service/transports/pure-cloud-v2-sockets-transport.js"]);