module TravelRules
  # NOTE: ALL THE COORDINATES IN `LocationBounds` MODULE ARE WRITTEN AS [lng, lat] PAIRS
  module LocationBounds
    GREATER_LONDON = [
      [-0.1050567626953125, 51.772088988916025],
      [-0.022916793823242188, 51.76159829412502],
      [0.07952213287353516, 51.748142734306946],
      [0.2032470703125, 51.70575744269406],
      [0.2882194519042969, 51.67247530584708],
      [0.3397178649902344, 51.6265425297861],
      [0.38988590240478516, 51.57650945896998],
      [0.38851261138916016, 51.5265814489318],
      [0.35555362701416016, 51.480019832311726],
      [0.3257274627685547, 51.40000888068026],
      [0.23755788803100586, 51.24465743079238],
      [-0.07941484451293945, 51.503540329961055],
      [-0.07578849792480469, 51.506999578072545],
      [-0.07158279418945312, 51.51545960526409],
      [-0.0748443603515625, 51.51889792020736],
      [-0.0823974609375, 51.519345215886794],
      [-0.09007930755615234, 51.52790974686554],
      [-0.09793281555175781, 51.5326285623104],
      [-0.1072239875793457, 51.537817359723014],
      [-0.11350035667419434, 51.53774228487819],
      [-0.12149333953857422, 51.54183118111469],
      [-0.13301610946655273, 51.54424330745314],
      [-0.15329360961914062, 51.5437729028094],
      [-0.1720905303955078, 51.54073016808757],
      [-0.18934249877929688, 51.53501781838798],
      [-0.2110147476196289, 51.52664819849633],
      [-0.22376060485839844, 51.516781551235944],
      [-0.23288816213607788, 51.50226558424248],
      [-0.23789584636688232, 51.49132568150603],
      [-0.2289426326751709, 51.489216382109],
      [-0.22519826889038086, 51.47735372213733],
      [-0.22020936012268066, 51.47040707160302],
      [-0.21559327840805054, 51.468135564729145],
      [-0.2116638422012329, 51.4675749805373],
      [-0.20792484283447266, 51.46559826060376],
      [-0.1943206787109375, 51.463686625815555],
      [-0.181674063205719, 51.468641003587614],
      [-0.1746922731399536, 51.48091852355204],
      [-0.15552252531051636, 51.48362618322197],
      [-0.14216110110282898, 51.48364372151749],
      [-0.13583779335021973, 51.483394008959614],
      [-0.13455703854560852, 51.48413980194039],
      [-0.1333785429596901, 51.48296327246271],
      [-0.13391666114330292, 51.48408509973423],
      [-0.13319045305252075, 51.484030397462426],
      [-0.13027891516685486, 51.484508935722864],
      [-0.12496411800384521, 51.486564171219854],
      [-0.11014223098754883, 51.48903935016731],
      [-0.09466052055358887, 51.49377555283866],
      [-0.07941886782646179, 51.503537408187746],
      [0.2375471591949463, 51.244649875054925],
      [0.056841373443603516, 51.20394590736846],
      [-0.18050193786621094, 51.19943512137391],
      [-0.38005828857421875, 51.23666444587571],
      [-0.4890632629394531, 51.28597042110153],
      [-0.5508184432983398, 51.32439693167705],
      [-0.5988407135009766, 51.37050780837475],
      [-0.6485366821289062, 51.42516282943641],
      [-0.6448888778686523, 51.53867487249877],
      [-0.6554138660430908, 51.641052995594585],
      [-0.8535204827785492, 51.722679275887444],
      [-0.8868321776390076, 51.851687253191805],
      [-0.5634409189224243, 51.8768983165039],
      [-0.5013799667358398, 51.75857014656989],
      [-0.4387664794921875, 51.79184205701331],
      [-0.259552001953125, 51.78823192706476],
      [-0.1696014404296875, 51.77548798218808],
      [-0.1050567626953125, 51.772088988916025]
    ].freeze

    CENTRAL_LONDON = [
      [-0.24169921875, 51.49335472541077],
      [-0.22796630859375, 51.51622073035779],
      [-0.21389007568359375, 51.5271154427087],
      [-0.190887451171875, 51.53565849143191],
      [-0.17681121826171875, 51.54462696721446],
      [-0.1517486572265625, 51.549537526460604],
      [-0.12908935546875, 51.54825656210026],
      [-0.11569976806640625, 51.54484048081099],
      [-0.11157989501953125, 51.53822109343163],
      [-0.10540008544921875, 51.53864817973767],
      [-0.08754730224609375, 51.528183411474586],
      [-0.08136749267578125, 51.52027984939518],
      [-0.07312774658203125, 51.519425328081894],
      [-0.06969451904296875, 51.51515248101072],
      [-0.07381439208984375, 51.50639189133809],
      [-0.070037841796875, 51.49805708407405],
      [-0.07038116455078125, 51.49613345052725],
      [-0.11775970458984375, 51.47796179607124],
      [-0.1956939697265625, 51.461280258392385],
      [-0.22144317626953125, 51.46833857638139],
      [-0.23242950439453125, 51.487796767005534],
      [-0.24169921875, 51.49335472541077]
    ].freeze

    BIRMINGHAM = [
      [-1.9683838449418545, 52.544477537972355],
      [-2.015762384980917, 52.51105840075719],
      [-2.0298386178910732, 52.47301321320222],
      [-2.024002131074667, 52.437865360631164],
      [-1.995163019746542, 52.41274257344449],
      [-1.9052124582231045, 52.39389108642726],
      [-1.761703547090292, 52.40520294524503],
      [-1.708145197480917, 52.44749196657735],
      [-1.7102051340043545, 52.4688304160653],
      [-1.758956965059042, 52.51314784184714],
      [-1.823501642793417, 52.52651791243298],
      [-1.9683838449418545, 52.544477537972355]
    ].freeze

    LEEDS = [
      [-1.6028022766113281, 53.82801519713633],
      [-1.6028022766113281, 53.82674872252093],
      [-1.602029800415039, 53.82284774013148],
      [-1.601858139038086, 53.81899706366467],
      [-1.602029800415039, 53.81329639954038],
      [-1.5932750701904297, 53.80850724241072],
      [-1.5829753875732422, 53.8037682256614],
      [-1.5843486785888672, 53.802070158830006],
      [-1.585550308227539, 53.80105635480384],
      [-1.5830612182617188, 53.798166878853095],
      [-1.5709590911865234, 53.78899020544744],
      [-1.545724868774414, 53.78320939167689],
      [-1.5331077575683594, 53.78412220469961],
      [-1.5122509002685547, 53.78868597194841],
      [-1.5069293975830078, 53.80257705165136],
      [-1.5124225616455078, 53.814841989541314],
      [-1.5573978424072266, 53.81615949667113],
      [-1.5563678741455078, 53.826444762915926],
      [-1.5695858001708984, 53.83138383323869],
      [-1.5833187103271484, 53.83054803150506],
      [-1.6003131866455078, 53.82933229012095],
      [-1.6028022766113281, 53.82801519713633]
    ].freeze

    GLASGOW = [
      [-4.2590332590043545, 55.72890647740787],
      [-4.308815058320761, 55.72793982443528],
      [-4.353103693574667, 55.74552916281829],
      [-4.4609070383012295, 55.814649874904944],
      [-4.500045832246542, 55.844923926243794],
      [-4.5144653879106045, 55.880566935906906],
      [-4.4691467843949795, 55.929258232149806],
      [-4.374733027070761, 55.93166234411858],
      [-4.321861322969198, 55.946372259751556],
      [-4.2164612375199795, 55.92714249022724],
      [-4.116897638887167, 55.90482399703348],
      [-4.0338135324418545, 55.86554305983032],
      [-4.0351868234574795, 55.82082229423757],
      [-4.002914484590292, 55.765814704827505],
      [-4.0887451730668545, 55.76253109476654],
      [-4.1450501047074795, 55.76233793262178],
      [-4.2041016183793545, 55.747461573776164],
      [-4.2590332590043545, 55.72890647740787]
    ].freeze

    MANCHESTER = [
      [-4.2590332590043545, 55.72890647740787],
      [-4.308815058320761, 55.72793982443528],
      [-4.353103693574667, 55.74552916281829],
      [-4.4609070383012295, 55.814649874904944],
      [-4.500045832246542, 55.844923926243794],
      [-4.5144653879106045, 55.880566935906906],
      [-4.4691467843949795, 55.929258232149806],
      [-4.374733027070761, 55.93166234411858],
      [-4.321861322969198, 55.946372259751556],
      [-4.2164612375199795, 55.92714249022724],
      [-4.116897638887167, 55.90482399703348],
      [-4.0338135324418545, 55.86554305983032],
      [-4.0351868234574795, 55.82082229423757],
      [-4.002914484590292, 55.765814704827505],
      [-4.0887451730668545, 55.76253109476654],
      [-4.1450501047074795, 55.76233793262178],
      [-4.2041016183793545, 55.747461573776164],
      [-4.2590332590043545, 55.72890647740787]
    ].freeze

    EDINBURGH = [
      [-3.1800270080566406, 55.99396489421163],
      [-3.2871437072753906, 55.970340002298805],
      [-3.2948684692382812, 55.96380699804833],
      [-3.246631622314453, 55.93247168513718],
      [-3.1937599182128906, 55.92073845157609],
      [-3.1662940979003906, 55.924393446236905],
      [-3.1480979919433594, 55.93227936568622],
      [-3.1086158752441406, 55.954005423411175],
      [-3.1800270080566406, 55.99396489421163]
    ].freeze

    LIVERPOOL = [
      [-2.9309463500976562, 53.53132947195095],
      [-2.9810714721679688, 53.53214572511981],
      [-3.0250167846679688, 53.52520707167195],
      [-3.052396774291992, 53.51704249452471],
      [-3.0668163299560547, 53.50754919566109],
      [-3.0495643615722656, 53.473335274124445],
      [-3.0262184143066406, 53.454326969671854],
      [-3.013601303100586, 53.43919600129776],
      [-3.008451461791992, 53.42723054262682],
      [-3.0063915252685547, 53.41515940279853],
      [-3.001241683959961, 53.403801219243675],
      [-2.994718551635742, 53.39632976960831],
      [-2.9819297790527344, 53.379847003377186],
      [-2.963733673095703, 53.370220573956786],
      [-2.938671112060547, 53.36038708103963],
      [-2.9151535034179688, 53.34809202306838],
      [-2.8801345825195312, 53.32923271182326],
      [-2.8471755981445312, 53.32513175791219],
      [-2.8039169311523438, 53.32103040980665],
      [-2.7845191955566406, 53.320825332053474],
      [-2.7690696716308594, 53.33210314502438],
      [-2.759113311767578, 53.34317300677391],
      [-2.716197967529297, 53.34973156905316],
      [-2.6897621154785156, 53.36223103384358],
      [-2.680492401123047, 53.37011815343644],
      [-2.6874446868896484, 53.38680944713405],
      [-2.691049575805664, 53.395920337195776],
      [-2.7396297454833984, 53.40768994782367],
      [-2.753877639770508, 53.42262754609993],
      [-2.768983840942383, 53.42651455367774],
      [-2.784261703491211, 53.43909374669326],
      [-2.818422317504883, 53.43346936448051],
      [-2.8331851959228516, 53.42927615888975],
      [-2.848806381225586, 53.43663956236166],
      [-2.860994338989258, 53.44972690762585],
      [-2.8971290588378906, 53.469861273507824],
      [-2.9256248474121094, 53.485185606792584],
      [-2.9173851013183594, 53.50315910192688],
      [-2.910175323486328, 53.52398248541041],
      [-2.9309463500976562, 53.53132947195095]
    ].freeze
  end

  module Locations
    COORDINATE_SYSTEM = 4326

    def self.includes?(name, lat:, lng:)
      rgeo.point(lng.to_f, lat.to_f).within?(self[name])
    end

    def self.[](name)
      polygons[name.to_s]
    end

    def self.polygons
      @polygons ||= {}
    end

    def self.create_polygon(name, bounds, inner: nil)
      polygons[name] = rgeo.polygon(create_line_string(bounds), inner && [create_line_string(inner)])
    end

    def self.create_line_string(bounds)
      rgeo.line_string(bounds.map{ |lng, lat| rgeo.point(lng, lat) })
    end

    def self.rgeo
      @rgeo ||= RGeo::Geos.factory(srid: COORDINATE_SYSTEM)
    end

    create_polygon 'GreaterLondon', LocationBounds::GREATER_LONDON, inner: LocationBounds::CENTRAL_LONDON
    create_polygon 'CentralLondon', LocationBounds::CENTRAL_LONDON
    create_polygon 'Birmingham',    LocationBounds::BIRMINGHAM
    create_polygon 'Leeds',         LocationBounds::LEEDS
    create_polygon 'Glasgow',       LocationBounds::GLASGOW
    create_polygon 'Manchester',    LocationBounds::MANCHESTER
    create_polygon 'Edinburgh',     LocationBounds::EDINBURGH
    create_polygon 'Liverpool',     LocationBounds::LIVERPOOL

    private_class_method :polygons, :create_polygon, :create_line_string, :rgeo
  end
end
